<!DOCTYPE html>    
<HTML content-type='utf-8' lang="de-DE"  id='PageContent'>    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400&display=swap" />
    <link rel="stylesheet" href="./FBA/mobile_green.css"/>
    <HEAD>
        <meta charset="ISO-8859-1">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />        
        <TITLE>Mobile Balance - Transfer</TITLE>        
    </HEAD>        
    <BODY onload="getFromServer(putResponse)" style="background-color:#000; ">   
        <DIV class="dosborder">
			<DIV class="dostable">
				<DIV  class="attrLine"> 
					<DIV class="L22">&nbsp;</DIV>
					<DIV class="C100"><button id="read-button" onclick="getFromServer(putResponse)" )>Load</button> </DIV>
				</DIV>
     		</DIV>
		</DIV>
       
    <SCRIPT type="text/javascript" src="/client.js"></SCRIPT>
    <SCRIPT type="text/javascript" src="/money.js"></SCRIPT>
    
    <SCRIPT type="text/javascript">            

        // character count for normal columns
        let iCpField = 16;

        let debug=1;

        // data-sharing amoing different functions
        var gResponse;
        var gAccounts;
        var gHistory;
        var gSchema;
        var gAssets;
        var gPatterns;
        var page;
        
        var accountPages={};

        const TARGET = 'file-contents';

        var cCent=0;
        var historicLine;

        var creditList={}; // { "COGK":{cents:"1370,00" }}
        var debitList={}; // { "COGK":{cents:"1370,00" }}

        function listCreditAccount(i,name) {
            if(cCent>0) {
                creditList[name]= {"index":i, "cents":cCent};
            } else delete creditList[name];

            showTransfer(validateCD(creditList,debitList));
        }

        function listDebitAccount(i,name) {
            if(cCent>0) {
                debitList[name]= {"index":i, "cents":cCent}
            } else delete debitList[name];

            showTransfer(validateCD(creditList,debitList));
        }

        function toggleC2D(name) {
            console.log("toggleC2D="+name);
            if(name && creditList[name]) {
                var account=creditList[name];
                debitList[name]=account;
                delete creditList[name]; 
                showTransfer(validateCD(creditList,debitList));
            }
        }

        function toggleD2C(name) {
            console.log("toggleD2C="+name);
            if(name && debitList[name]) {
                var account=debitList[name];
                creditList[name]=account;
                delete debitList[name]; 
                showTransfer(validateCD(creditList,debitList));
            }
        }

        var creditDivs="";
        var debitDivs="";

        function clearCD() { 
            creditList={}; 
            debitList={}; 
            showTransfer(validateCD(creditList,debitList));
        }


        function setNull() {
            cCent=0;
            showTransfer(validateCD(creditList,debitList));
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        // GH20211015
        function addInfo(row,parts) {
            var sender="",refAcct="",info4="",info5="";
            if(parts) {                
                    if(parts.length>2) { sender=parts[2];
                        if(parts.length>3) { refAcct=parts[3];
                            if(parts.length>4) { info4=parts[4];
                                if(parts.length>5) { info5=parts[5];
                            }
                        }
                    }
                }
            }
            return ('<DIV id="sel'+row+'" class="L120"><button '
                +' onclick="putInfo(\''+sender+'\',\''+refAcct+'\',\''+info4+'\',\''+info5+'\')" >'
                +row+'</button></DIV>');
        }

                    
        function putResponse(strTarget,strText) {       

            response = JSON.parse(strText);

            gHistory  = response[D_History];
            gAccounts= response[D_Balance];
            gSchema  = response[D_Schema];
            gAssets = response[D_FixAss];
            gPatterns  = response[D_Muster];

            page = response[D_Page];
            
            cCent=0;
            creditList={}; 
            debitList={}; 

            historicLine=0;

            daysPassed=0;
            document.addEventListener('keydown', (event) => {
                var keyValue = event.key;
                var codeValue = event.code;
                
                console.log("Transfer keyValue: " + keyValue);
                console.log("Transfer codeValue: " + codeValue);
               
                if(keyValue==='Shift' || keyValue==='+' || keyValue==='-') {
                    if(keyValue==='+') daysPassed--;
                    if(keyValue==='-') daysPassed++;
                    var cdate = document.getElementById('date');
                    cdate.setAttribute("value", bookingDate(daysPassed));
                }
                else if(codeValue==='ArrowUp') doCommand('<');
                else if(codeValue==='ArrowDown') doCommand('>');              
        //        else if(codeValue.slice(0,5)==='Digit') doCommand(keyValue);
                else if(keyValue==='x') doCommand('X');
                else if(keyValue==='/') doCommand('/');
                else if(keyValue==='#') doCommand('/');
            }, false);

            showTransfer(validateCD(creditList,debitList));
        }  

        function bookingDate(daysPassed){
            date = new Date();
            day = date.getDate()-daysPassed; 
            month = date.getMonth() + 1;
            year = date.getFullYear();

            if(day<0) { day+=32; month--;}
            if(day<0) { day+=32; month--;}
            if(month<1){ month=12;year--;}

            if (month < 10) month = "0" + month;
            if (day < 10) day = "0" + day;

            today = year + "-" + month + "-" + day; 

            return today;
        }


        function doCommand(cmd) {  
            var mCredit=cents2EU(cCent);
            console.log("doCommand1 CREDIT="+mCredit+" APPEND '"+cmd+"'");

            if(cmd==='X') mCredit="0,00"; // reset amount
            
            else {
                if(cmd==='/') mCredit=mCredit.slice(0,-1); // delete one digit
                else if(cmd==='<')  restoreHistoric(--historicLine);
                else if(cmd==='>')  restoreHistoric(++historicLine);
                else mCredit=mCredit+cmd; // append digit
            }

            cCent = parseInt(mCredit.replace(".","").replace(",",""));
            console.log("doCommand2 mCredit="+mCredit+"   cCent '"+cCent+"'");
            
            var cdList = validateCD(creditList,debitList);
            delete cdList.diff; // 20220516
            showTransfer(cdList); 
            // override .diff from validateCD 
        }
        
        let assetPattern = [ "HASH", "DATE", "WKN", "SELL",  "NUMBER","NAME#" ];

        function restoreHistoric(index) {

            // positive index is from history
            // negative index is from patterns
            // o is asset pattern
            let hKeys = Object.keys(gHistory);
            let pKeys = Object.keys(gPatterns);
            var sEntry=assetPattern;
            if(index<0) {
                if(index<-pKeys.length) index=1-pKeys.length;
                let hash = pKeys[-index];
                let txn = gPatterns[hash];
                let delta = txn.delta; // cd list
                sEntry = [ hash, txn.date, txn.sender, txn.acct, txn.svwz, txn.svwz2 ];
            } else {
                if(index>hKeys.length) index=hKeys.length-1;
                sEntry = gHistory[hKeys[index]];
            }

            var cdate = document.getElementById('date');
            var cSender = document.getElementById('sender');
            var crefAcct = document.getElementById('refAcct');
            var cInfo4 = document.getElementById('info4');
            var cInfo5 = document.getElementById('info5');
            
            cSender.setAttribute("value", sEntry[2]);
            crefAcct.setAttribute("value",sEntry[3]);
            cInfo4.setAttribute("value",  sEntry[4]);
            cInfo5.setAttribute("value",  sEntry[5]); 

            let aLen = gSchema.assets;
            let eLen = gSchema.eqliab;
            let names=gSchema.Names;
            for(var i = J_ACCT;i<sEntry.length;i++) {
                let name = names[i];
                delete creditList[name];
                delete debitList[name];
                if(i!=aLen && i!=eLen) {
                    let money = setEUMoney(sEntry[i]);
                    let cAmount = money.cents;

                    if(i>aLen) cAmount = -money.cents;

                    if(cAmount>0) {
                        //console.log("HISTORY CREDIT "+name+": "+sEntry[i]+"="+cAmount);
                        creditList[name]= {"index":i, "cents":cAmount};

                    } else if(cAmount<0) {
                        //console.log("HISTORY DEBIT "+name+": "+sEntry[i]+"="+cAmount);
                        debitList[name]= {"index":i, "cents":-cAmount};
                    }
                }             
            }
        }

        function book() {
            var cdate = document.getElementById('date');
            var cSender = document.getElementById('sender');
            var cInfo3 = document.getElementById('refAcct');
            var cInfo4 = document.getElementById('info4');
            var cInfo5 = document.getElementById('info5');

            var date=cdate.value; // date
            var sender=cSender.value;
            var refAcct=cInfo3.value;
            var info4=cInfo4.value;
            var info5=cInfo5.value; // SVWZ2

            if(!date) date=".";
            if(!sender) sender=".";
            if(!refAcct) refAcct=".";
            if(!info4) info4=".";
            if(!info5) info5=".";

            // effective transaction: no flag
            var jInfo = { /*"flag":1,*/ "date":date, "sender":sender, "refAcct":refAcct, "svwz":info4, "svwz2":info5, "credit":creditList, "debit":debitList };

            cdate.value=""; // mark dialog as processed, so user wont hit multiple times
            
            save(jInfo);
        }

       </script>
   </BODY> 
</HTML>